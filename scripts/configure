#!/bin/bash

mkdir -p data/pccs

if [[ ! -f ".env" ]]; then
  cp ".env.example" ".env"

  function specify_env_variable() {
    local prompt_message=$1
    local env_variable=$2
    local default_value=$3

    read -r -e -i "$default_value" -p "$prompt_message" value
    sed -i "s@$env_variable=@$env_variable=$value@g" ".env"

    export "$env_variable"="$value"
  }

  specify_env_variable "Specify the Raiko docker image name: " "SRN_RAIKO_IMAGE" "raiko"
  specify_env_variable "Specify the PCCS docker image name: " "SRN_PCCS_IMAGE" "pccs"
  specify_env_variable "Specify the images tag: " "SRN_IMAGES_TAG" "latest"

  read -r -e -p "Do you want specify the network configuration? [Y/n]: " SPECIFY_NETWORK
  if [ "$SPECIFY_NETWORK" != "N" ] && [ "$SPECIFY_NETWORK" != "n" ]; then
    specify_env_variable "Specify the L1 network [holesky, ethereum]: " "SRN_L1_NETWORK" "holesky"
    specify_env_variable "Specify the L2 network [taiko_a7, taiko_mainnet]: " "SRN_NETWORK" "taiko_a7"

    if [ "$SRN_L1_NETWORK" == "ethereum" ]; then
      specify_env_variable "Specify the Ethereum RPC endpoint: " "SRN_ETHEREUM_RPC"
      specify_env_variable "Specify the Ethereum Beacon RPC endpoint: " "SRN_ETHEREUM_BEACON_RPC"
    else
      specify_env_variable "Specify the Holesky RPC endpoint: " "SRN_HOLESKY_RPC"
      specify_env_variable "Specify the Holesky Beacon RPC endpoint: " "SRN_HOLESKY_BEACON_RPC"
    fi

    if [ "$SRN_NETWORK" == "taiko_a7" ]; then
      specify_env_variable "Specify the Taiko A7 RPC endpoint: " "SRN_TAIKO_A7_RPC"
    else
      specify_env_variable "Specify the Taiko Mainnet RPC endpoint: " "SRN_TAIKO_MAINNET_RPC"
    fi
  fi

  specify_env_variable "Specify the raiko port: " "SRN_RAIKO_PORT" "8080"

  read -r -e -p "Do you want collect metrics? [Y/n]: " COLLECT_METRICS
  if [ "$COLLECT_METRICS" != "N" ] && [ "$COLLECT_METRICS" != "n" ]; then
    sed -i "s@COMPOSE_PROFILES=@COMPOSE_PROFILES=metrics@g" ".env"
    specify_env_variable "Specify the prometheus port: " "SRN_PROMETHEUS_PORT" "9090"
    specify_env_variable "Specify the grafana port: " "SRN_GRAFANA_PORT" "3000"
  fi
else
  echo "Using existing .env file"
  source ".env"
fi

crt_path="data/pccs/file.crt"
if [[ ! -f "$crt_path" ]]; then
  openssl genrsa -out "data/pccs/private.pem" 2048
  chmod 644 "data/pccs/private.pem"
  openssl req -new -subj "/C=US" -key "data/pccs/private.pem" -out "data/pccs/csr.pem"
  openssl x509 -req -days 365 -in "data/pccs/csr.pem" -signkey "data/pccs/private.pem" -out ${crt_path}
  rm -rf "data/pccs/csr.pem"
fi

config_path="data/pccs/default.json"
if [[ ! -f "$config_path" ]]; then
  cp "src/raiko/docker/pccs-defaut-example.json" "${config_path}"
  chmod 644 "${config_path}"

  if [[ -z "$INTEL_API_KEY" ]]; then
    read -r -e -p "Please provide your Intel API key: " -i "${INTEL_API_KEY}" INTEL_API_KEY
  fi

  if [[ -n "$INTEL_API_KEY" ]]; then
    sed -i "s/\YOUR_API_KEY/$INTEL_API_KEY/g" "${config_path}"
  fi

  read -r -e -p "Please create admin password for PCCS: " -i "$(openssl rand -hex 8)" ADMIN_TOKEN
  sed -i "s/\YOUR_USER_TOKEN_HASH/$(echo -n "$ADMIN_TOKEN" | sha512sum | tr -d '[:space:]-')/g" "${config_path}"
  echo "PCCS_ADMIN_TOKEN=$ADMIN_TOKEN" >>".env"

  read -r -e -p "Please create user password for PCCS: " -i "$(openssl rand -hex 8)" USER_TOKEN
  sed -i "s/\YOUR_ADMIN_TOKEN_HASH/$(echo -n "$USER_TOKEN" | sha512sum | tr -d '[:space:]-')/g" "${config_path}"
  echo "PCCS_USER_TOKEN=$USER_TOKEN" >>".env"
fi
